BEGIN;

CREATE TABLE IF NOT EXISTS PROGRAM_DATA.TRAJECTORY_SPLITS (
	MMSI INTEGER NOT NULL,
	SURROGATE_KEY SERIAL,
	DIST_THRES DOUBLE PRECISION,
	TIME_THRES INTERVAL,
	SUB_TRAJ GEOMETRY NOT NULL,
	PRIMARY KEY (MMSI, SURROGATE_KEY),
	CONSTRAINT HAS_TIMESTAMP CHECK (ST_HASM (SUB_TRAJ)), -- might be redundant
	CONSTRAINT POINT_OR_TRAJECTORY CHECK (
		(ST_ISVALIDTRAJECTORY (SUB_TRAJ) = TRUE)
		OR (GEOMETRYTYPE (SUB_TRAJ) = 'POINTM')
	),
	CONSTRAINT IS_4326 CHECK (ST_SRID (SUB_TRAJ) = 4326),
	UNIQUE (MMSI, DIST_THRES, TIME_THRES)
);

ALTER TABLE IF EXISTS PROGRAM_DATA.TRAJECTORY_SPLITS OWNER TO POSTGRES;

COMMENT ON TABLE PROGRAM_DATA.TRAJECTORY_SPLITS IS 'Trajectories that have been split into smaller sub-trajectories (sometimes with length = 1)';

CREATE INDEX IF NOT EXISTS MMSI_HASH_IDX ON PROGRAM_DATA.TRAJECTORY_SPLITS USING HASH (MMSI);

CREATE INDEX IF NOT EXISTS SUB_TRAJ_GIST_IDX ON PROGRAM_DATA.TRAJECTORY_SPLITS USING GIST (SUB_TRAJ) INCLUDE (MMSI, DIST_THRES, TIME_THRES);

COMMIT;
